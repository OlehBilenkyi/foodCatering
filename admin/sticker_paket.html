<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/assets/stylescss/styles_paket.css" />
    <title>Etykiety Menu na Opakowania</title>
</head>
<body>
    <div class="container" id="sticker-container">
        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞–∫–ª–µ–π–∫–∏ -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
                const packageStickerDataJSON = localStorage.getItem('packageStickerData');
                if (!packageStickerDataJSON) throw new Error("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ localStorage");

                const packageStickerData = JSON.parse(packageStickerDataJSON);
                if (!packageStickerData || !Array.isArray(packageStickerData.packages) || packageStickerData.packages.length === 0) {
                    throw new Error("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∏–ª–∏ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∞–∫–ª–µ–µ–∫");
                }

                const container = document.getElementById('sticker-container');
                if (!container) throw new Error("‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–∞–∫–ª–µ–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");

                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–∏–ø—É –ø–∞–∫–µ—Ç–∞
                packageStickerData.packages.sort((a, b) => (parseInt(a.package_type) || 0) - (parseInt(b.package_type) || 0));

                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞–∫–ª–µ–µ–∫
                packageStickerData.packages.forEach((packageInfo) => {
                    const stickerElement = document.createElement('div');
                    stickerElement.classList.add('sticker-paket');

                    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–µ–Ω—é)
                    const menuTitle = `Menu: ${escapeHTML(packageInfo.menu_type || 'Standardowe')} ${escapeHTML(packageInfo.package_type)} kalorii`;

                    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
                    const address = packageInfo.address ? escapeHTML(packageInfo.address) : "Nie podano adresu";

                    stickerElement.innerHTML = `
                        <div class="sticker-paket-header">
                            <h1 class="title-text">${menuTitle}</h1>
                            <img class="logo-image" src="/assets/img/sticker_container.png" alt="Logo firmy" />
                        </div>
                        <div class="sticker-paket-info">
                            <div class="info-block">
                                <span class="info-label">Adres:</span>
                                <span class="info-value">${address}</span>
                            </div>
                            <div class="info-block">
                                <span class="info-label">Data:</span>
                                <span class="info-value">${escapeHTML(packageStickerData.delivery_date)}</span>
                            </div>
                        </div>
                    `;

                    container.appendChild(stickerElement);
                });

                console.log(`‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞–∫–ª–µ–µ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—Å–µ–≥–æ: ${packageStickerData.packages.length}`);

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                setTimeout(() => {
                    window.print();
                    setTimeout(() => {
                        localStorage.removeItem('packageStickerData'); // –û—á–∏—â–∞–µ–º localStorage
                        console.log("üóëÔ∏è –î–∞–Ω–Ω—ã–µ –∏–∑ localStorage —É–¥–∞–ª–µ–Ω—ã");

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–æ –ª–∏ –æ–∫–Ω–æ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
                        if (window.opener == null) {
                            window.close();
                        }
                    }, 1000);
                }, 500);

            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞–∫–ª–µ–µ–∫:", error.message);
                alert(error.message);
                window.location.href = "/admin/orders_summary.php";
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
        function escapeHTML(str) {
            return String(str).replace(/[&<>"']/g, (match) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[match]));
        }
    </script>
</body>
</html>
